// Generated by CoffeeScript 1.4.0

/**
 * @package       Shop
 * @order_status  modules
 * @author        Nazar Mokrynskyi <nazar@mokrynskyi.com>
 * @copyright     Copyright (c) 2014, Nazar Mokrynskyi
 * @license       MIT License, see license.txt
*/


(function() {
  var L;

  L = cs.Language;

  Polymer({
    shipping_types: cs.shop.shipping_types,
    shipping_type: 0,
    shipping_type_details: {},
    shipping_type_text: L.shop_shipping_type,
    shipping_cost_formatted: '',
    shipping_username_text: L.shop_shipping_username,
    phone_text: L.shop_shipping_phone,
    address_text: L.shop_shipping_address,
    comment_text: L.shop_comment,
    finish_order_text: L.shop_finish_order,
    shipping_username: localStorage.shipping_username || '',
    phone: localStorage.phone || '',
    address: localStorage.address || '',
    comment: localStorage.comment || '',
    created: function() {
      this.shipping_type_details = this.shipping_types[0];
      this.shipping_type = this.shipping_type_details.id;
      return this.shipping_username = this.shipping_username || (cs.is_user ? this.getAttribute('username') : '');
    },
    ready: function() {
      this.$.h1.innerHTML = this.querySelector('h1').innerHTML;
      $(this.shadowRoot).find('textarea').autosize();
      return this.shipping_typeChanged();
    },
    shipping_typeChanged: function() {
      var _this = this;
      return this.shipping_types.forEach(function(shipping_type) {
        if (shipping_type.id === _this.shipping_type) {
          _this.shipping_type_details = shipping_type;
          _this.shipping_cost_formatted = sprintf(cs.shop.settings.price_formatting, shipping_type.price);
          return false;
        }
      });
    },
    shipping_usernameChanged: function() {
      return localStorage.shipping_username = this.shipping_username;
    },
    phoneChanged: function() {
      return localStorage.phone = this.phone;
    },
    addressChanged: function() {
      return localStorage.address = this.address;
    },
    commentChanged: function() {
      return localStorage.comment = this.comment;
    },
    finish_order: function() {
      return $.ajax({
        url: 'api/Shop/orders',
        type: 'post',
        data: {
          shipping_type: this.shipping_type,
          shipping_username: this.shipping_username,
          shipping_phone: this.shipping_type_details.phone_needed ? this.phone : '',
          shipping_address: this.shipping_type_details.address_needed ? this.address : '',
          comment: this.comment,
          items: cs.shop.cart.get_all()
        },
        success: function() {
          return $.cs.simple_modal("<h1 class=\"uk-text-center\">" + L.shop_thanks_for_order + "</h1>").on('hide.uk.modal', function() {
            cs.shop.cart.clean();
            return location.href = 'Shop/orders_';
          });
        }
      });
    }
  });

}).call(this);
