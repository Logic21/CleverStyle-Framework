// Generated by LiveScript 1.4.0
/**
 * @package    CleverStyle CMS
 * @subpackage System module
 * @category   modules
 * @author     Nazar Mokrynskyi <nazar@mokrynskyi.com>
 * @copyright  Copyright (c) 2015, Nazar Mokrynskyi
 * @license    MIT License, see license.txt
 */
(function(){
  var L;
  L = cs.Language;
  Polymer({
    'is': 'cs-system-admin-components-blocks-list',
    behaviors: [cs.Polymer.behaviors.Language],
    properties: {
      blocks: Object,
      blocks_count: Number,
      positions: {
        notify: true,
        type: String
      }
    },
    ready: function(){
      var this$ = this;
      $.getJSON('api/System/admin/blocks', function(blocks){
        var blocks_grouped, i$, len$, index, block;
        this$.blocks_count = blocks.length;
        blocks_grouped = {
          top: [],
          left: [],
          floating: [],
          right: [],
          bottom: []
        };
        for (i$ = 0, len$ = blocks.length; i$ < len$; ++i$) {
          index = i$;
          block = blocks[i$];
          block.order = index;
          blocks_grouped[block.position].push(block);
        }
        this$.set('blocks', blocks_grouped);
        this$._init_sortable();
      });
    },
    _init_sortable: function(){
      var $shadowRoot, $group, this$ = this;
      $shadowRoot = $(this.shadowRoot);
      if ($shadowRoot.find('[group] > div:not(:first)').length < this.blocks_count) {
        setTimeout(this._init_sortable.bind(this), 100);
        return;
      }
      $group = $shadowRoot.find('[group]');
      $group.sortable({
        connectWith: 'blocks-list',
        items: 'div:not(:first)',
        placeholder: '<div class="cs-block-primary">'
      }).on('sortupdate', function(){
        var get_indexes;
        get_indexes = function(it){
          return $group.filter("[group=" + it + "]").children('div:not(:first)').map(function(){
            return this.order;
          }).get();
        };
        this$.positions = JSON.stringify({
          top: get_indexes('top'),
          left: get_indexes('left'),
          floating: get_indexes('floating'),
          right: get_indexes('right'),
          bottom: get_indexes('bottom')
        });
      });
    },
    _status_class: function(active){
      if (active == 1) {
        return 'cs-block-success cs-text-success';
      } else {
        return 'cs-block-warning cs-text-warning';
      }
    },
    _reload: function(){
      location.reload();
    },
    _block_permissions: function(e){
      var title;
      title = L.permissions_for_block(e.model.item.title);
      cs.ui.simple_modal("<h2>" + title + "</h2>\n<cs-system-admin-permissions-for-item label=\"" + e.model.item.index + "\" group=\"Block\"/>");
    },
    _add_block: function(){
      var this$ = this;
      $(cs.ui.simple_modal("<h2>" + L.adding_a_block + "</h2>\n<cs-system-admin-components-blocks-form/>")).on('close', function(){
        this$._reload();
      });
    },
    _edit_block: function(e){
      var title, this$ = this;
      title = L.editing_a_block(e.model.item.title);
      $(cs.ui.simple_modal("<h2>" + title + "</h2>\n<cs-system-admin-components-blocks-form index=\"" + e.model.item.index + "\"/>")).on('close', function(){
        this$._reload();
      });
    },
    _delete_block: function(e){
      var title, this$ = this;
      title = L.sure_to_delete_block(e.model.item.title);
      cs.ui.confirm("<h3>" + title + "</h3>", function(){
        $.ajax({
          url: 'api/System/admin/blocks/' + e.model.item.index,
          type: 'delete',
          success: function(){
            cs.ui.notify(L.changes_saved, 'success', 5);
            this$._reload();
          }
        });
      });
    }
  });
}).call(this);
